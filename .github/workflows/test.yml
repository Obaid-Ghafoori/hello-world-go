name: Go Test and Linting

on:
  push:
    branches: [main, develop, feature/*]
  # pull_request:
  #   branches: [main, develop, feature/*]

env:
  GO_VERSION: "1.23.0"  
  MIN_COVERAGE: 80    

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}

  test-and-coverage-linting:
    name: Run Tests and Enforce Coverage
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Unit Tests and Calculate Coverage
        run: |
          echo "Running unit tests and calculating coverage..."
          go test -coverprofile=coverage.out ./... || exit 1
          go tool cover -func=coverage.out
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4.6.0
        with:
          name: coverage-report
          path: coverage.html
          # The desired behavior if no files are found using the provided path
          if-no-files-found: warn # optional, default is 'warn'
          # Duration after which artifact will expire in days
          retention-days: 7 # optional, default is 90
          # The level of compression for Zlib to be applied to the artifact archive
          compression-level: 6 # optional, default is 6
          # If true, an artifact with a matching name will be deleted before a new one is uploaded
          overwrite: false # optional, default is false
          # If true, hidden files will be included in the artifact
          include-hidden-files: false # optional, default is false
          # Additional arguments to be passed to the 'tar' command
          extra-args: --no-recursion

        